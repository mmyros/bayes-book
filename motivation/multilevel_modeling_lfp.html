
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multilevel modeling of LFP &#8212; My sample book</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">My sample book</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   Welcome to your Jupyter Book
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../lfp_example/lfp_roc.html">
   Compare to ANOVA and LMM: ROC curve
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../lfp_example/quick_lfp.html">
   LFP example
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/motivation/multilevel_modeling_lfp.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/executablebooks/jupyter-book"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fmotivation/multilevel_modeling_lfp.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/executablebooks/jupyter-book/master?urlpath=tree/docs/motivation/multilevel_modeling_lfp.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#we-will-work-toward-a-partial-pooling-model-with-treatment">
   We will work toward a partial pooling model with treatment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-organization">
   Data organization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conventional-approaches">
   Conventional approaches
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#complete-pooling">
     Complete pooling
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#unpooled-model">
     Unpooled model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multilevel-and-hierarchical-models">
   Multilevel and hierarchical models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#partial-pooling-model-without-treatment">
   Partial pooling model without treatment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#full-model-partial-pooling-with-treatment">
   Full model: Partial pooling with treatment
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#benefits-of-multilevel-models">
   Benefits of Multilevel Models
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="multilevel-modeling-of-lfp">
<h1>Multilevel modeling of LFP<a class="headerlink" href="#multilevel-modeling-of-lfp" title="Permalink to this headline">¶</a></h1>
<p>This is a slight reworking of the classic Gelman’s radon example</p>
<p>Implementations in:</p>
<ul class="simple">
<li><p>tensorflow <a class="reference external" href="https://www.tensorflow.org/probability/examples/Multilevel_Modeling_Primer">https://www.tensorflow.org/probability/examples/Multilevel_Modeling_Primer</a></p></li>
<li><p>pymc3 <a class="reference external" href="https://docs.pymc.io/notebooks/multilevel_modeling.html">https://docs.pymc.io/notebooks/multilevel_modeling.html</a></p></li>
<li><p>stan <a class="reference external" href="https://mc-stan.org/users/documentation/case-studies/radon.html">https://mc-stan.org/users/documentation/case-studies/radon.html</a></p></li>
<li><p>pyro <a class="reference external" href="https://github.com/pyro-ppl/pyro-models/blob/master/pyro_models/arm/radon.py">https://github.com/pyro-ppl/pyro-models/blob/master/pyro_models/arm/radon.py</a></p></li>
<li><p>numpyro fibrosis dataset <a class="reference external" href="http://num.pyro.ai/en/stable/tutorials/bayesian_hierarchical_linear_regression.html">http://num.pyro.ai/en/stable/tutorials/bayesian_hierarchical_linear_regression.html</a></p></li>
</ul>
<p>Why this notebook? It’s a common departure point to consider multilevel models in neuroscience.</p>
<p>Hierarchical or multilevel modeling is a generalization of regression modeling. <em>Multilevel models</em> are regression models in which the constituent model parameters are given <strong>probability models</strong>. This implies that model parameters are allowed to <strong>vary by group</strong>. Observational units are often naturally <strong>clustered</strong>. Clustering induces dependence between observations, despite random sampling of clusters and random sampling within clusters.</p>
<p>A <em>hierarchical model</em> is a particular multilevel model where parameters are nested within one another. Some multilevel structures are not hierarchical – e.g. “country” and “year” are not nested, but may represent separate, but overlapping, clusters of parameters. We will motivate this topic using a neuroscience example.</p>
<p>Example: LFP power (modified Gelman and Hill 2006)</p>
<p>LFP power is a measure of neuronal activity. It can varies greatly from mouse to mouse.</p>
<p>The EPA did a study of radon levels in 80,000 households (more on this study and modeling here <a class="reference external" href="https://pymc3-testing.readthedocs.io/en/rtd-docs/notebooks/multilevel_modeling.html">https://pymc3-testing.readthedocs.io/en/rtd-docs/notebooks/multilevel_modeling.html</a>). We are going to call homes “trials”, counties “mice”, and radon levels “power.” The power is going to vary depending on “no_stim” (originally floor condition) or “stim” (originally basement condition) that in our case denote, say, optogenetic stimulation. There are two important predictors:</p>
<ul class="simple">
<li><p>measurement in stim or first no_stim (power higher in stims)</p></li>
<li><p>mouse power level (positive correlation with power levels by mouse)</p></li>
</ul>
<p>The hierarchy in this example is neurons within mouse.</p>
<p>Data:</p>
<ul class="simple">
<li><p>85 mice</p></li>
<li><p>2 treatments (stim, no stim)</p></li>
<li><p>912 trials</p></li>
</ul>
<p>When we pool our data, we imply that they are sampled from the same source. This ignores any variation among sampling units (other than sampling variance) – we assume that mice are all the same:</p>
<p><img alt="pooled" src="../_images/pooled.png" /></p>
<p>When we analyze data unpooled, we imply that they are sampled independently from separate models. At the opposite extreme from the pooled case, this approach claims that differences between sampling units are too large to combine them – we assume that mice have no similarity whatsoever:</p>
<p><img alt="unpooled" src="../_images/unpooled.png" /></p>
<p>In a hierarchical model, parameters are viewed as a sample from a population distribution of parameters. Thus, we view them as being neither entirely different or exactly the same. This is <em><strong>partial pooling</strong></em>:</p>
<p><img alt="hierarchical" src="../_images/parpooled.png" /></p>
<p>Simplification 1 (Complete pooling, ecological):</p>
<div class="math notranslate nohighlight">
\[y_i = \alpha + \beta x_i + \epsilon_i\]</div>
<p>Simplification 2 (No pooling, atomistic):</p>
<div class="math notranslate nohighlight">
\[y_i = \alpha_{j[i]} + \beta x_i + \epsilon_i\]</div>
<div class="section" id="we-will-work-toward-a-partial-pooling-model-with-treatment">
<h2>We will work toward a partial pooling model with treatment<a class="headerlink" href="#we-will-work-toward-a-partial-pooling-model-with-treatment" title="Permalink to this headline">¶</a></h2>
<div class="math notranslate nohighlight">
\[\begin{split} 
\begin{cases}
    y_i = \alpha_{j[i]} + \beta x_{i} + \epsilon_i \\
    \alpha_{j[i]} \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)
\end{cases}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(j = 1,\ldots,85\)</span></p>
<p>For this demonstration, we will omit <span class="math notranslate nohighlight">\(\beta\)</span>s for all examples except last and instead have two intercepts for stim and no-stim:</p>
<div class="math notranslate nohighlight">
\[y_i = \alpha^{stim}+\alpha^{no-stim} + x_i + \epsilon_i\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[y_i = \alpha_{j[i]}^{stim}+\alpha_{j[i]}^{no-stim} + x_i + \epsilon_i\]</div>
</div>
<div class="section" id="data-organization">
<h2>Data organization<a class="headerlink" href="#data-organization" title="Permalink to this headline">¶</a></h2>
<p>First, we import the data from a local file, and extract data.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="kn">import</span> <span class="nn">arviz</span> <span class="k">as</span> <span class="nn">az</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pymc3</span> <span class="k">as</span> <span class="nn">pm</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">theano</span> <span class="kn">import</span> <span class="n">tensor</span> <span class="k">as</span> <span class="n">tt</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">FutureWarning</span><span class="p">)</span>
<span class="n">RANDOM_SEED</span> <span class="o">=</span> <span class="mi">8924</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">286</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">az</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;arviz-darkgrid&quot;</span><span class="p">)</span>
<span class="c1"># Import power data</span>
<span class="n">srrs2</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;srrs2.dat&#39;</span><span class="p">))</span>
<span class="n">srrs2</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">srrs2</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">)</span>
<span class="c1"># Select a subset of &quot;mice&quot; from Minnesota</span>
<span class="n">srrs_mn</span> <span class="o">=</span> <span class="n">srrs2</span><span class="p">[</span><span class="n">srrs2</span><span class="o">.</span><span class="n">state</span><span class="o">==</span><span class="s1">&#39;MN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Next, obtain the mouse-level predictor, power, by combining two variables.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">srrs_mn</span><span class="p">[</span><span class="s1">&#39;fips&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">stfips</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">cntyfips</span>
<span class="n">cty</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">pm</span><span class="o">.</span><span class="n">get_data</span><span class="p">(</span><span class="s1">&#39;cty.dat&#39;</span><span class="p">))</span>
<span class="n">cty_mn</span> <span class="o">=</span> <span class="n">cty</span><span class="p">[</span><span class="n">cty</span><span class="o">.</span><span class="n">st</span><span class="o">==</span><span class="s1">&#39;MN&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">cty_mn</span><span class="p">[</span> <span class="s1">&#39;fips&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="n">cty_mn</span><span class="o">.</span><span class="n">stfips</span> <span class="o">+</span> <span class="n">cty_mn</span><span class="o">.</span><span class="n">ctfips</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="nb">print</span><span class="p">(</span><span class="n">srrs_mn</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">srrs_mn</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cty_mn</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">cty_mn</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;idnum&#39;, &#39;state&#39;, &#39;state2&#39;, &#39;stfips&#39;, &#39;zip&#39;, &#39;region&#39;, &#39;typebldg&#39;,
       &#39;floor&#39;, &#39;room&#39;, &#39;basement&#39;, &#39;windoor&#39;, &#39;rep&#39;, &#39;stratum&#39;, &#39;wave&#39;,
       &#39;starttm&#39;, &#39;stoptm&#39;, &#39;startdt&#39;, &#39;stopdt&#39;, &#39;activity&#39;, &#39;pcterr&#39;, &#39;adjwt&#39;,
       &#39;dupflag&#39;, &#39;zipflag&#39;, &#39;cntyfips&#39;, &#39;county&#39;, &#39;fips&#39;],
      dtype=&#39;object&#39;) (919, 26)
Index([&#39;stfips&#39;, &#39;ctfips&#39;, &#39;st&#39;, &#39;cty&#39;, &#39;lon&#39;, &#39;lat&#39;, &#39;Uppm&#39;, &#39;fips&#39;], dtype=&#39;object&#39;) (89, 8)
</pre></div>
</div>
</div>
</div>
<p>Use the <code class="docutils literal notranslate"><span class="pre">merge</span></code> method to combine neuron- and mouse-level information in a single DataFrame.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">srrs_mn</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">cty_mn</span><span class="p">[[</span><span class="s1">&#39;fips&#39;</span><span class="p">,</span> <span class="s1">&#39;Uppm&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;fips&#39;</span><span class="p">)</span>
<span class="n">srrs_mn</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;idnum&#39;</span><span class="p">)</span>
<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">srrs_mn</span><span class="o">.</span><span class="n">Uppm</span><span class="p">)</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">srrs_mn</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">srrs_mn</span><span class="p">[</span><span class="s1">&#39;Uppm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">srrs_mn</span><span class="p">[</span><span class="s1">&#39;activity&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span>
<span class="c1">#plt.scatter(srrs_mn[&#39;Uppm&#39;],srrs_mn[&#39;activity&#39;])</span>

<span class="c1"># HIDE CODE</span>

<span class="c1"># Rename environmental variables to represent </span>
<span class="c1"># what we think of as a neuroscience example</span>
<span class="n">srrs_mn</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;floor&#39;</span><span class="p">:</span><span class="s1">&#39;no_stim&#39;</span><span class="p">,</span><span class="s1">&#39;basement&#39;</span><span class="p">:</span><span class="s1">&#39;stim&#39;</span><span class="p">,</span><span class="s1">&#39;county&#39;</span><span class="p">:</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span>
                <span class="s1">&#39;activity&#39;</span><span class="p">:</span><span class="s1">&#39;power&#39;</span><span class="p">},</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># HIDE CODE</span>

<span class="n">srrs_mn</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>idnum</th>
      <th>state</th>
      <th>state2</th>
      <th>stfips</th>
      <th>zip</th>
      <th>region</th>
      <th>typebldg</th>
      <th>no_stim</th>
      <th>room</th>
      <th>stim</th>
      <th>...</th>
      <th>stopdt</th>
      <th>power</th>
      <th>pcterr</th>
      <th>adjwt</th>
      <th>dupflag</th>
      <th>zipflag</th>
      <th>cntyfips</th>
      <th>mouse</th>
      <th>fips</th>
      <th>Uppm</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5081</td>
      <td>MN</td>
      <td>MN</td>
      <td>27</td>
      <td>55735</td>
      <td>5</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>N</td>
      <td>...</td>
      <td>12288</td>
      <td>2.2</td>
      <td>9.7</td>
      <td>1146.499190</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>AITKIN</td>
      <td>27001</td>
      <td>0.502054</td>
    </tr>
    <tr>
      <th>1</th>
      <td>5082</td>
      <td>MN</td>
      <td>MN</td>
      <td>27</td>
      <td>55748</td>
      <td>5</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>Y</td>
      <td>...</td>
      <td>12088</td>
      <td>2.2</td>
      <td>14.5</td>
      <td>471.366223</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>AITKIN</td>
      <td>27001</td>
      <td>0.502054</td>
    </tr>
    <tr>
      <th>2</th>
      <td>5083</td>
      <td>MN</td>
      <td>MN</td>
      <td>27</td>
      <td>55748</td>
      <td>5</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>Y</td>
      <td>...</td>
      <td>21188</td>
      <td>2.9</td>
      <td>9.6</td>
      <td>433.316718</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>AITKIN</td>
      <td>27001</td>
      <td>0.502054</td>
    </tr>
    <tr>
      <th>3</th>
      <td>5084</td>
      <td>MN</td>
      <td>MN</td>
      <td>27</td>
      <td>56469</td>
      <td>5</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>Y</td>
      <td>...</td>
      <td>123187</td>
      <td>1.0</td>
      <td>24.3</td>
      <td>461.623670</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>AITKIN</td>
      <td>27001</td>
      <td>0.502054</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5085</td>
      <td>MN</td>
      <td>MN</td>
      <td>27</td>
      <td>55011</td>
      <td>3</td>
      <td>1</td>
      <td>0</td>
      <td>4</td>
      <td>Y</td>
      <td>...</td>
      <td>13088</td>
      <td>3.1</td>
      <td>13.8</td>
      <td>433.316718</td>
      <td>0</td>
      <td>0</td>
      <td>3</td>
      <td>ANOKA</td>
      <td>27003</td>
      <td>0.428565</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 27 columns</p>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="c1"># Rename environmental variables to represent </span>
<span class="c1"># what we think of as a neuroscience example</span>
<span class="n">srrs_mn</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s1">&#39;floor&#39;</span><span class="p">:</span><span class="s1">&#39;no_stim&#39;</span><span class="p">,</span><span class="s1">&#39;basement&#39;</span><span class="p">:</span><span class="s1">&#39;stim&#39;</span><span class="p">,</span><span class="s1">&#39;county&#39;</span><span class="p">:</span><span class="s1">&#39;mouse&#39;</span><span class="p">,</span>
                <span class="s1">&#39;activity&#39;</span><span class="p">:</span><span class="s1">&#39;power&#39;</span><span class="p">},</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We also need a lookup table (<code class="docutils literal notranslate"><span class="pre">dict</span></code>) for each unique mouse, for indexing.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">srrs_mn</span><span class="o">.</span><span class="n">mouse</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">mouse</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="o">.</span><span class="n">strip</span><span class="p">)</span>
<span class="n">mn_mice</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">mouse</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">n_mice</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mn_mice</span><span class="p">)</span>
<span class="n">mouse_lookup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mn_mice</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_mice</span><span class="p">)))</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, create local copies of variables.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">mouse</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="p">[</span><span class="s1">&#39;mouse_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">mouse</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">mouse_lookup</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">power</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">power</span>
<span class="n">srrs_mn</span><span class="p">[</span><span class="s1">&#39;log_power&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_power</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">power</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
<span class="n">no_stim</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">no_stim</span><span class="o">.</span><span class="n">values</span>
</pre></div>
</div>
</div>
</div>
<p>Distribution of power levels (log scale):</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">srrs_mn</span><span class="o">.</span><span class="n">log_power</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_28_0.png" src="../_images/multilevel_modeling_lfp_28_0.png" />
</div>
</div>
</div>
<div class="section" id="conventional-approaches">
<h2>Conventional approaches<a class="headerlink" href="#conventional-approaches" title="Permalink to this headline">¶</a></h2>
<p>The two conventional alternatives to modeling power exposure represent the two extremes of the bias-variance tradeoff:</p>
<p><em><strong>Complete pooling</strong></em>:</p>
<p>Treat all mice the same, and estimate a single power level.</p>
<div class="math notranslate nohighlight">
\[y_i = \alpha + \beta x_i + \epsilon_i\]</div>
<p><em><strong>No pooling</strong></em>:</p>
<p>Model power in each mouse independently.</p>
<div class="math notranslate nohighlight">
\[y_i = \alpha_{j[i]} + \beta x_i + \epsilon_i\]</div>
<p>where <span class="math notranslate nohighlight">\(j = 1,\ldots,85\)</span></p>
<p>The errors <span class="math notranslate nohighlight">\(\epsilon_i\)</span> may represent measurement error or variation among trials.</p>
<div class="section" id="complete-pooling">
<h3>Complete pooling<a class="headerlink" href="#complete-pooling" title="Permalink to this headline">¶</a></h3>
<p>One intercept for all (ANOVA, ecological fallacy)</p>
<p>We’ll start by estimating the slope and intercept for the complete pooling model. You’ll notice that we used an <em>index</em> variable instead of an <em>indicator</em> variable in the linear model below. There are two main reasons. One, this generalizes well to more-than-two-category cases. Two, this approach correctly considers that neither category has more prior uncertainty than the other. On the contrary, the indicator variable approach necessarily assumes that one of the categories has more uncertainty than the other: here, the cases when <code class="docutils literal notranslate"><span class="pre">no_stim=1</span></code> would take into account 2 priors (<span class="math notranslate nohighlight">\(\alpha + \beta\)</span>), whereas cases when <code class="docutils literal notranslate"><span class="pre">no_stim=0</span></code> would have only one prior (<span class="math notranslate nohighlight">\(\alpha\)</span>). But <em>a priori</em> we aren’t more unsure about no_stim measurements than about stim measurements, so it makes sense to give them the same prior uncertainty.</p>
<p>Now for the model:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">pooled_model</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">theta</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">no_stim</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">log_power</span><span class="p">)</span>
    
<span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">pooled_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">ipykernel_2147</span><span class="o">/</span><span class="mf">2276465127.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> 
<span class="ne">----&gt; </span><span class="mi">9</span>     <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">log_power</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> 
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">pooled_model</span><span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/pymc3/distributions/distribution.py</span> in <span class="ni">__new__</span><span class="nt">(cls, name, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>             <span class="n">dist</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">120</span>         <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">121</span>             <span class="n">dist</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">122</span>         <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">Var</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">total_size</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">123</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/pymc3/distributions/distribution.py</span> in <span class="ni">dist</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">128</span>     <span class="k">def</span> <span class="nf">dist</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">129</span>         <span class="n">dist</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">130</span>         <span class="n">dist</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">131</span>         <span class="k">return</span> <span class="n">dist</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/pymc3/distributions/continuous.py</span> in <span class="ni">__init__</span><span class="nt">(self, mu, sigma, tau, sd, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">481</span>         <span class="k">if</span> <span class="n">sd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">482</span>             <span class="n">sigma</span> <span class="o">=</span> <span class="n">sd</span>
<span class="ne">--&gt; </span><span class="mi">483</span>         <span class="n">tau</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">=</span> <span class="n">get_tau_sigma</span><span class="p">(</span><span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">484</span>         <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">as_tensor_variable</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">485</span>         <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="n">as_tensor_variable</span><span class="p">(</span><span class="n">tau</span><span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/pymc3/distributions/continuous.py</span> in <span class="ni">get_tau_sigma</span><span class="nt">(tau, sigma)</span>
<span class="g g-Whitespace">    </span><span class="mi">175</span>     <span class="c1"># cast tau and sigma to float in a way that works for both np.arrays</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="c1"># and pure python</span>
<span class="ne">--&gt; </span><span class="mi">177</span>     <span class="n">tau</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">tau</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span>     <span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">sigma</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/tensor/var.py</span> in <span class="ni">__rmul__</span><span class="nt">(self, other)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> 
<span class="g g-Whitespace">    </span><span class="mi">203</span>     <span class="k">def</span> <span class="fm">__rmul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">204</span>         <span class="k">return</span> <span class="n">theano</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">basic</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">205</span> 
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">def</span> <span class="nf">__rdiv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/graph/op.py</span> in <span class="ni">__call__</span><span class="nt">(self, *inputs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span> 
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">compute_test_value</span> <span class="o">!=</span> <span class="s2">&quot;off&quot;</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">253</span>             <span class="n">compute_test_value</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">254</span> 
<span class="g g-Whitespace">    </span><span class="mi">255</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/graph/op.py</span> in <span class="ni">compute_test_value</span><span class="nt">(node)</span>
<span class="g g-Whitespace">    </span><span class="mi">124</span> 
<span class="g g-Whitespace">    </span><span class="mi">125</span>     <span class="c1"># Create a thunk that performs the computation</span>
<span class="ne">--&gt; </span><span class="mi">126</span>     <span class="n">thunk</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">make_thunk</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">storage_map</span><span class="p">,</span> <span class="n">compute_map</span><span class="p">,</span> <span class="n">no_recycling</span><span class="o">=</span><span class="p">[])</span>
<span class="g g-Whitespace">    </span><span class="mi">127</span>     <span class="n">thunk</span><span class="o">.</span><span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">storage_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">inputs</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">128</span>     <span class="n">thunk</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">storage_map</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">outputs</span><span class="p">]</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/graph/op.py</span> in <span class="ni">make_thunk</span><span class="nt">(self, node, storage_map, compute_map, no_recycling, impl)</span>
<span class="g g-Whitespace">    </span><span class="mi">632</span>             <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">633</span>             <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">634</span>                 <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_c_thunk</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">storage_map</span><span class="p">,</span> <span class="n">compute_map</span><span class="p">,</span> <span class="n">no_recycling</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">635</span>             <span class="k">except</span> <span class="p">(</span><span class="ne">NotImplementedError</span><span class="p">,</span> <span class="n">MethodNotDefined</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">636</span>                 <span class="c1"># We requested the c code, so don&#39;t catch the error.</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/graph/op.py</span> in <span class="ni">make_c_thunk</span><span class="nt">(self, node, storage_map, compute_map, no_recycling)</span>
<span class="g g-Whitespace">    </span><span class="mi">599</span>                 <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;float16&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">600</span>         <span class="n">outputs</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">make_thunk</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">601</span>             <span class="n">input_storage</span><span class="o">=</span><span class="n">node_input_storage</span><span class="p">,</span> <span class="n">output_storage</span><span class="o">=</span><span class="n">node_output_storage</span>
<span class="g g-Whitespace">    </span><span class="mi">602</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">603</span>         <span class="n">thunk</span><span class="p">,</span> <span class="n">node_input_filters</span><span class="p">,</span> <span class="n">node_output_filters</span> <span class="o">=</span> <span class="n">outputs</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/link/c/basic.py</span> in <span class="ni">make_thunk</span><span class="nt">(self, input_storage, output_storage, storage_map)</span>
<span class="g g-Whitespace">   </span><span class="mi">1202</span>         <span class="n">init_tasks</span><span class="p">,</span> <span class="n">tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_init_tasks</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">1203</span>         <span class="n">cthunk</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">in_storage</span><span class="p">,</span> <span class="n">out_storage</span><span class="p">,</span> <span class="n">error_storage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__compile__</span><span class="p">(</span>
<span class="ne">-&gt; </span><span class="mi">1204</span>             <span class="n">input_storage</span><span class="p">,</span> <span class="n">output_storage</span><span class="p">,</span> <span class="n">storage_map</span>
<span class="g g-Whitespace">   </span><span class="mi">1205</span>         <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1206</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/link/c/basic.py</span> in <span class="ni">__compile__</span><span class="nt">(self, input_storage, output_storage, storage_map)</span>
<span class="g g-Whitespace">   </span><span class="mi">1140</span>             <span class="n">input_storage</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1141</span>             <span class="n">output_storage</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">1142</span>             <span class="n">storage_map</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1143</span>         <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1144</span>         <span class="k">return</span> <span class="p">(</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/link/c/basic.py</span> in <span class="ni">cthunk_factory</span><span class="nt">(self, error_storage, in_storage, out_storage, storage_map)</span>
<span class="g g-Whitespace">   </span><span class="mi">1632</span>             <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_order</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1633</span>                 <span class="n">node</span><span class="o">.</span><span class="n">op</span><span class="o">.</span><span class="n">prepare_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">storage_map</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1634</span>             <span class="n">module</span> <span class="o">=</span> <span class="n">get_module_cache</span><span class="p">()</span><span class="o">.</span><span class="n">module_from_key</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span> <span class="n">lnk</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1635</span> 
<span class="g g-Whitespace">   </span><span class="mi">1636</span>         <span class="nb">vars</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">orphans</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/link/c/cmodule.py</span> in <span class="ni">module_from_key</span><span class="nt">(self, key, lnk)</span>
<span class="g g-Whitespace">   </span><span class="mi">1189</span>             <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1190</span>                 <span class="n">location</span> <span class="o">=</span> <span class="n">dlimport_workdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirname</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">1191</span>                 <span class="n">module</span> <span class="o">=</span> <span class="n">lnk</span><span class="o">.</span><span class="n">compile_cmodule</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1192</span>                 <span class="n">name</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="vm">__file__</span>
<span class="g g-Whitespace">   </span><span class="mi">1193</span>                 <span class="k">assert</span> <span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/link/c/basic.py</span> in <span class="ni">compile_cmodule</span><span class="nt">(self, location)</span>
<span class="g g-Whitespace">   </span><span class="mi">1548</span>                     <span class="n">lib_dirs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_dirs</span><span class="p">(),</span>
<span class="g g-Whitespace">   </span><span class="mi">1549</span>                     <span class="n">libs</span><span class="o">=</span><span class="n">libs</span><span class="p">,</span>
<span class="ne">-&gt; </span><span class="mi">1550</span>                     <span class="n">preargs</span><span class="o">=</span><span class="n">preargs</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1551</span>                 <span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1552</span>             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/link/c/cmodule.py</span> in <span class="ni">compile_str</span><span class="nt">(module_name, src_code, location, include_dirs, lib_dirs, libs, preargs, py_module, hide_symbols)</span>
<span class="g g-Whitespace">   </span><span class="mi">2494</span> 
<span class="g g-Whitespace">   </span><span class="mi">2495</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">2496</span>             <span class="n">p_out</span> <span class="o">=</span> <span class="n">output_subprocess_Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2497</span>             <span class="n">compile_stderr</span> <span class="o">=</span> <span class="n">p_out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
<span class="g g-Whitespace">   </span><span class="mi">2498</span>         <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/site-packages/theano/utils.py</span> in <span class="ni">output_subprocess_Popen</span><span class="nt">(command, **params)</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>     <span class="c1"># we need to use communicate to make sure we don&#39;t deadlock around</span>
<span class="g g-Whitespace">    </span><span class="mi">253</span>     <span class="c1"># the stdout/stderr pipe.</span>
<span class="ne">--&gt; </span><span class="mi">254</span>     <span class="n">out</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">255</span>     <span class="k">return</span> <span class="n">out</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span><span class="p">,)</span>
<span class="g g-Whitespace">    </span><span class="mi">256</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/subprocess.py</span> in <span class="ni">communicate</span><span class="nt">(self, input, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">962</span> 
<span class="g g-Whitespace">    </span><span class="mi">963</span>             <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">964</span>                 <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_communicate</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">endtime</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">965</span>             <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">966</span>                 <span class="c1"># https://bugs.python.org/issue25942</span>

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/subprocess.py</span> in <span class="ni">_communicate</span><span class="nt">(self, input, endtime, orig_timeout)</span>
<span class="g g-Whitespace">   </span><span class="mi">1713</span>                             <span class="s1">&#39;failed to raise TimeoutExpired.&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1714</span> 
<span class="ne">-&gt; </span><span class="mi">1715</span>                     <span class="n">ready</span> <span class="o">=</span> <span class="n">selector</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1716</span>                     <span class="bp">self</span><span class="o">.</span><span class="n">_check_timeout</span><span class="p">(</span><span class="n">endtime</span><span class="p">,</span> <span class="n">orig_timeout</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1717</span> 

<span class="nn">/opt/hostedtoolcache/Python/3.7.12/x64/lib/python3.7/selectors.py</span> in <span class="ni">select</span><span class="nt">(self, timeout)</span>
<span class="g g-Whitespace">    </span><span class="mi">413</span>         <span class="n">ready</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">    </span><span class="mi">414</span>         <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">415</span>             <span class="n">fd_event_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selector</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">416</span>         <span class="k">except</span> <span class="ne">InterruptedError</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">417</span>             <span class="k">return</span> <span class="n">ready</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>Before running the model let’s do some prior predictive checks. Indeed, having sensible priors is not only a way to incorporate scientific knowledge into the model, it can also help and make the MCMC machinery faster – here we are dealing with a simple linear regression, so no link function comes and distorts the outcome space; but one day this will happen to you and you’ll need to think hard about your priors to help your MCMC sampler. So, better to train ourselves when it’s quite easy than having to learn when it’s very hard… There is a really neat function to do that in PyMC3:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pooled_model</span><span class="p">:</span>
    <span class="n">prior_checks</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_prior_predictive</span><span class="p">(</span><span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
    <span class="p">[</span><span class="n">prior_checks</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">prior_checks</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]],</span>
    <span class="s2">&quot;ok&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;no_stim measurement (binary)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;stim&quot;</span><span class="p">,</span> <span class="s2">&quot;no_stim&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean log power level&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_34_0.png" src="../_images/multilevel_modeling_lfp_34_0.png" />
</div>
</div>
<p>I’m no expert in power levels, but, before seing the data, these priors seem to allow for quite a wide range of the mean log power level. But don’t worry, we can always change these priors if sampling gives us hints that they might not be appropriate – after all, priors are assumptions, not oaths; and as most assumptions, they can be tested.</p>
<p>However, we can already think of an improvement. Do you see it? Remember what we said at the beginning: power levels tend to be higher in stims, so we could incorporate this prior scientific knowledge into our model by giving <span class="math notranslate nohighlight">\(a_{stim}\)</span> a higher mean than <span class="math notranslate nohighlight">\(a_{no_stim}\)</span>. Here, there are so much data that the prior should be washed out anyway, but we should keep this fact in mind – for future cases or if sampling proves more difficult than expected…</p>
<p>Speaking of sampling, let’s fire up the Bayesian machinery!</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pooled_model</span><span class="p">:</span>
    <span class="n">pooled_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='10000' class='' max='10000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [10000/10000 00:00<00:00 Average Loss = 1,154.2]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Finished [100%]: Average Loss = 1,154
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span> 
<span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pooled_model</span><span class="p">:</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">find_MAP</span><span class="p">()</span>
    <span class="n">pooled_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">pm</span><span class="o">.</span><span class="n">NUTS</span><span class="p">(</span><span class="n">scaling</span><span class="o">=</span><span class="n">start</span><span class="p">),</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">pooled_trace</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='14' class='' max='14' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [14/14 00:00<00:00 logp = -1,093.8, ||grad|| = 8.8772]
</div>
</div><div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Multiprocess sampling (4 chains in 4 jobs)
NUTS: [sigma, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='8000' class='' max='8000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [8000/8000 00:02<00:00 Sampling 4 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 1_000 tune and 1_000 draw iterations (4_000 + 4_000 draws total) took 2 seconds.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a[0]</th>
      <td>1.36</td>
      <td>0.03</td>
      <td>1.31</td>
      <td>1.42</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5272.63</td>
      <td>5272.63</td>
      <td>5263.06</td>
      <td>2963.49</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>a[1]</th>
      <td>0.78</td>
      <td>0.06</td>
      <td>0.66</td>
      <td>0.90</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5808.35</td>
      <td>5806.86</td>
      <td>5859.37</td>
      <td>3357.46</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.79</td>
      <td>0.02</td>
      <td>0.76</td>
      <td>0.83</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>5372.30</td>
      <td>5366.82</td>
      <td>5333.90</td>
      <td>2973.88</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pooled_model</span><span class="p">:</span>
    <span class="n">pooled_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">pooled_trace</span><span class="p">,</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [sigma, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='12000' class='' max='12000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [12000/12000 00:03<00:00 Sampling 4 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 2_000 tune and 1_000 draw iterations (8_000 + 4_000 draws total) took 4 seconds.
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a[0]</th>
      <td>1.36</td>
      <td>0.03</td>
      <td>1.31</td>
      <td>1.42</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4509.37</td>
      <td>4509.37</td>
      <td>4496.12</td>
      <td>2861.20</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>a[1]</th>
      <td>0.78</td>
      <td>0.06</td>
      <td>0.65</td>
      <td>0.90</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4696.39</td>
      <td>4688.65</td>
      <td>4666.29</td>
      <td>2308.57</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.79</td>
      <td>0.02</td>
      <td>0.76</td>
      <td>0.83</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4345.94</td>
      <td>4345.94</td>
      <td>4356.59</td>
      <td>2786.44</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>No divergences and a sampling that only took seconds – this is the Flash of samplers! Here the chains look very good (good R hat, good effective sample size, small sd), but remember to check your chains after sampling – <code class="docutils literal notranslate"><span class="pre">az.traceplot</span></code> is usually a good start.</p>
<p>Let’s see what it means on the outcome space: did the model pick-up the negative relationship between no_stim measurements and log power levels? What’s the uncertainty around its estimates? To estimate the uncertainty around the neuron power levels (not the average level, but measurements that would be likely in neurons), we need to sample the likelihood <code class="docutils literal notranslate"><span class="pre">y</span></code> from the model. In another words, we need to do posterior predictive checks:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pooled_model</span><span class="p">:</span>
    <span class="n">ppc</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample_posterior_predictive</span><span class="p">(</span><span class="n">pooled_trace</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span>

<span class="n">a_stim</span><span class="p">,</span> <span class="n">a_no_stim</span> <span class="o">=</span> <span class="n">pooled_trace</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">power_stim</span><span class="p">,</span> <span class="n">power_no_stim</span> <span class="o">=</span> <span class="n">ppc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ppc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># we know that no_stim=0/1 at these columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='4000' class='' max='4000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [4000/4000 00:31<00:00]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
</pre></div>
</div>
</div>
</div>
<p>We can then use these samples in our plot:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">no_stim</span><span class="p">,</span> <span class="n">log_power</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Observations&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_hpd</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
    <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">power_stim</span><span class="p">,</span> <span class="n">power_no_stim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> 
    <span class="n">fill_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Exp. distrib. of power levels&quot;</span><span class="p">},</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">az</span><span class="o">.</span><span class="n">plot_hpd</span><span class="p">(</span>
    <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
    <span class="n">pooled_trace</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">],</span> 
    <span class="n">fill_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Exp. mean HPD&quot;</span><span class="p">},</span>
    <span class="n">show</span><span class="o">=</span><span class="kc">False</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">a_stim</span><span class="p">,</span> <span class="n">a_no_stim</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Exp. mean&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;stim&quot;</span><span class="p">,</span> <span class="s2">&quot;no_stim&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;no_stim measurement (binary)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Log power level&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/m/anaconda3/envs/tf/lib/python3.6/site-packages/arviz/data/base.py:146: UserWarning: More chains (4000) than draws (2). Passed array should have shape (chains, draws, *shape)
  UserWarning,
/home/m/anaconda3/envs/tf/lib/python3.6/site-packages/arviz/data/base.py:146: UserWarning: More chains (4000) than draws (2). Passed array should have shape (chains, draws, *shape)
  UserWarning,
</pre></div>
</div>
<img alt="../_images/multilevel_modeling_lfp_42_1.png" src="../_images/multilevel_modeling_lfp_42_1.png" />
</div>
</div>
<p>The 94% interval of the expected value is very narrow, and even narrower for stim measurements, meaning that the model is slightly more confident about these observations. The sampling distribution of individual power levels is much wider. We can infer that no_stim level does account for some of the variation in power levels. We can see however that the model underestimates the dispersion in power levels across neurons – lots of them lie outside the light orange prediction envelope. So this model is a good start but we can’t stop there.</p>
<p>Let’s compare it to the unpooled model, where we estimate the power level for each mouse:</p>
</div>
<div class="section" id="unpooled-model">
<h3>Unpooled model<a class="headerlink" href="#unpooled-model" title="Permalink to this headline">¶</a></h3>
<p>An intercept for [mouse X stim] (ANOVA on trials, atomistic fallacy)</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="c1"># updated version:</span>
<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">unpooled_model</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">n_mice</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    
    <span class="n">theta</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">mouse</span><span class="p">,</span> <span class="n">no_stim</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">log_power</span><span class="p">)</span>

<span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">unpooled_model</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_45_0.svg" src="../_images/multilevel_modeling_lfp_45_0.svg" /></div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">unpooled_model</span><span class="p">:</span>
    <span class="n">unpooled_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [sigma, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='12000' class='' max='12000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [12000/12000 00:08<00:00 Sampling 4 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 2_000 tune and 1_000 draw iterations (8_000 + 4_000 draws total) took 8 seconds.
</pre></div>
</div>
</div>
</div>
<p>Sampling went fine again. Let’s look at the expected values for both stim (dimension 0) and no_stim (dimension 1) in each mouse:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">unpooled_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="n">r_hat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_48_0.png" src="../_images/multilevel_modeling_lfp_48_0.png" />
</div>
</div>
<p>Sampling was good for all mice, but you can see that some are more uncertain than others, and all of these uncertain estimates are for no_stim measurements. This probably comes from the fact that some mice just have a handful of no_stim measurements, so the model is pretty uncertain about them.</p>
<p>To identify mice with high power levels, we can plot the ordered mean estimates, as well as their 94% HPD:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">a_stim_unpooled</span><span class="p">,</span> <span class="n">a_no_stim_unpooled</span> <span class="o">=</span> <span class="n">unpooled_trace</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">unpooled_trace</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">unpooled_stim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;stim&quot;</span><span class="p">:</span> <span class="n">a_stim_unpooled</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> 
                            <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">az</span><span class="o">.</span><span class="n">hpd</span><span class="p">(</span><span class="n">a_stim_unpooled</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span> 
                            <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">az</span><span class="o">.</span><span class="n">hpd</span><span class="p">(</span><span class="n">a_stim_unpooled</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="p">},</span> 
                        <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> 
                        <span class="n">columns</span><span class="o">=</span><span class="n">mn_mice</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;stim&quot;</span><span class="p">)</span>
<span class="n">unpooled_no_stim</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;no_stim&quot;</span><span class="p">:</span> <span class="n">a_no_stim_unpooled</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                        <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">az</span><span class="o">.</span><span class="n">hpd</span><span class="p">(</span><span class="n">a_no_stim_unpooled</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span> 
                        <span class="s2">&quot;high&quot;</span><span class="p">:</span> <span class="n">az</span><span class="o">.</span><span class="n">hpd</span><span class="p">(</span><span class="n">a_no_stim_unpooled</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">},</span> 
                    <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> 
                    <span class="n">columns</span><span class="o">=</span><span class="n">mn_mice</span>
                <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;no_stim&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/m/anaconda3/envs/tf/lib/python3.6/site-packages/arviz/stats/stats.py:338: UserWarning: hpd will be deprecated Please replace hdi
  warnings.warn((&quot;hpd will be deprecated &quot; &quot;Please replace hdi&quot;),)
/home/m/anaconda3/envs/tf/lib/python3.6/site-packages/arviz/data/base.py:146: UserWarning: More chains (4000) than draws (85). Passed array should have shape (chains, draws, *shape)
  UserWarning,
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">estimates</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="p">[</span><span class="n">unpooled_stim</span><span class="p">,</span> <span class="n">unpooled_no_stim</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;stim&quot;</span><span class="p">,</span> <span class="s2">&quot;no_stim&quot;</span><span class="p">]):</span>    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_mice</span><span class="p">),</span> <span class="n">estimates</span><span class="o">.</span><span class="n">low</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">estimates</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_mice</span><span class="p">),</span> <span class="n">estimates</span><span class="p">[</span><span class="n">level</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> estimates&quot;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Ordered mouse&quot;</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">86</span><span class="p">),</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;power estimate&quot;</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">4.5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_51_0.png" src="../_images/multilevel_modeling_lfp_51_0.png" />
</div>
</div>
<p>There seems to be more dispersion in power levels for no_stim measurements than for stim ones. Moreover, as we saw in the forest plot, no_stim estimates are globally more uncertain, especially in some mice. We speculated that this is due to smaller sample sizes in the data, but let’s verify it!</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">n_no_stim_meas</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;mouse&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">no_stim</span>
<span class="n">uncertainty</span> <span class="o">=</span> <span class="p">(</span><span class="n">unpooled_no_stim</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="n">unpooled_no_stim</span><span class="o">.</span><span class="n">low</span><span class="p">)</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span> <span class="c1"># sort index to match counties alphabetically</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_no_stim_meas</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Nbr no_stim measurements in mouse&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Estimates&#39; uncertainty&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_53_0.png" src="../_images/multilevel_modeling_lfp_53_0.png" />
</div>
</div>
<p>Bingo! This makes sense: it’s very hard to estimate no_stim power levels in mice where there are no no_stim measurements, and the model is telling us that by being very uncertain in its estimates for those mice. This is a classic issue with no-pooling models: when you estimate clusters independently from each other, what do you with small-sample-size mice?</p>
<p>Another way to see this phenomenon is to visually compare the pooled and unpooled estimates for a subset of mice representing a range of sample sizes:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="c1"># These mice were named as counties in Minnesota, how curious</span>
<span class="n">SAMPLE_mice</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;LAC QUI PARLE&#39;</span><span class="p">,</span> <span class="s1">&#39;AITKIN&#39;</span><span class="p">,</span> <span class="s1">&#39;KOOCHICHING&#39;</span><span class="p">,</span> 
                    <span class="s1">&#39;DOUGLAS&#39;</span><span class="p">,</span> <span class="s1">&#39;CLAY&#39;</span><span class="p">,</span> <span class="s1">&#39;STEARNS&#39;</span><span class="p">,</span> <span class="s1">&#39;RAMSEY&#39;</span><span class="p">,</span> <span class="s1">&#39;ST LOUIS&#39;</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> 
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SAMPLE_mice</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">no_stim</span><span class="p">[</span><span class="n">srrs_mn</span><span class="o">.</span><span class="n">mouse</span><span class="o">==</span><span class="n">c</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">log_power</span><span class="p">[</span><span class="n">srrs_mn</span><span class="o">.</span><span class="n">mouse</span><span class="o">==</span><span class="n">c</span><span class="p">]</span>
    
    <span class="c1"># plot obs:</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    
    <span class="c1"># plot both models:</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">unpooled_stim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;stim&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="n">unpooled_no_stim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;no_stim&quot;</span><span class="p">]],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Unpooled&#39;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">a_stim</span><span class="p">,</span> <span class="n">a_no_stim</span><span class="p">],</span> <span class="s2">&quot;r--&quot;</span><span class="p">,</span>  <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Pooled&#39;</span><span class="p">)</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;stim&quot;</span><span class="p">,</span> <span class="s2">&quot;no_stim&quot;</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">%</span><span class="k">2</span>:
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Log power level&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">%</span><span class="k">4</span>:
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Mouse name&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.05</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_55_0.png" src="../_images/multilevel_modeling_lfp_55_0.png" />
</div>
</div>
<p>Neither of these models are satisfactory:</p>
<ul class="simple">
<li><p>If we are trying to identify high-power mice, pooling is useless – because, by definition, the pooled model estimates power at the cohort-level. In other words, pooling leads to maximal <em>underfitting</em>: the variation across mice is not taken into account and only the overall population is estimated.</p></li>
<li><p>We do not trust extreme unpooled estimates produced by models using few observations. This leads to maximal <em>overfitting</em>: only the within-mouse variations are taken into account and the overall population (i.e the cohort-level, which tells us about similarites across mice) is not estimated.</p></li>
</ul>
<p>This issue is acute for small sample sizes, as seen above: in mice where we have few no_stim measurements, if power levels are higher for those data points than for stim ones (Aitkin, Koochiching, Ramsey), the model will estimate that power levels are higher in no_stims than stims for these mice. But we shouldn’t trust this conclusion, because both scientific knowledge and the situation in other mice tell us that it is usually the reverse (stim power &gt; no_stim power). So unless we have a lot of observations telling us otherwise for a given mouse, we should be skeptical and shrink our mouse-estimates to the cohort-estimates – in other words, we should balance between cluster-level and population-level information, and the amount of shrinkage will depend on how extreme and how numerous the data in each cluster are.</p>
<p>But how do we do that? Well, ladies and gentlemen, let me introduce you to… hierarchical models!</p>
</div>
</div>
<div class="section" id="multilevel-and-hierarchical-models">
<h2>Multilevel and hierarchical models<a class="headerlink" href="#multilevel-and-hierarchical-models" title="Permalink to this headline">¶</a></h2>
<p>When we pool our data, we imply that they are sampled from the same model. This ignores any variation among sampling units (other than sampling variance) – we assume that mice are all the same:</p>
<p><img alt="pooled" src="../_images/pooled.png" /></p>
<p>When we analyze data unpooled, we imply that they are sampled independently from separate models. At the opposite extreme from the pooled case, this approach claims that differences between sampling units are too large to combine them – we assume that mice have no similarity whatsoever:</p>
<p><img alt="unpooled" src="../_images/unpooled.png" /></p>
<p>In a hierarchical model, parameters are viewed as a sample from a population distribution of parameters. Thus, we view them as being neither entirely different or exactly the same. This is <em><strong>partial pooling</strong></em>:</p>
<p><img alt="hierarchical" src="../_images/parpooled.png" /></p>
<p>We can use PyMC to easily specify multilevel models, and fit them using Markov chain Monte Carlo.</p>
</div>
<div class="section" id="partial-pooling-model-without-treatment">
<h2>Partial pooling model without treatment<a class="headerlink" href="#partial-pooling-model-without-treatment" title="Permalink to this headline">¶</a></h2>
<p>The simplest partial pooling model for the neuron power dataset is one which simply estimates power levels, without any predictors at any level. A partial pooling model represents a compromise between the pooled and unpooled extremes, approximately a weighted average (based on sample size) of the unpooled mouse estimates and the pooled estimates.</p>
<div class="math notranslate nohighlight">
\[\hat{\alpha} \approx \frac{(n_j/\sigma_y^2)\bar{y}_j + (1/\sigma_{\alpha}^2)\bar{y}}{(n_j/\sigma_y^2) + (1/\sigma_{\alpha}^2)}\]</div>
<p>Estimates for mice with smaller sample sizes will shrink towards the cohort-wide average.</p>
<p>Estimates for mice with larger sample sizes will be closer to the unpooled mouse estimates and will influence the the cohort-wide average.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">partial_pooling</span><span class="p">:</span>
    <span class="c1"># Hyperpriors:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    
    <span class="c1"># Varying intercepts:</span>
    <span class="n">a_mouse</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;a_mouse&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">n_mice</span><span class="p">)</span>
    
    <span class="c1"># Expected value per mouse:</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">a_mouse</span><span class="p">[</span><span class="n">mouse</span><span class="p">]</span>
    <span class="c1"># Model error:</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">log_power</span><span class="p">)</span>
<span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">partial_pooling</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_60_0.svg" src="../_images/multilevel_modeling_lfp_60_0.svg" /></div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">partial_pooling</span><span class="p">:</span>
    <span class="n">partial_pooling_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [sigma, a_mouse, sigma_a, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='12000' class='' max='12000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [12000/12000 00:08<00:00 Sampling 4 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 2_000 tune and 1_000 draw iterations (8_000 + 4_000 draws total) took 9 seconds.
The number of effective samples is smaller than 25% for some parameters.
</pre></div>
</div>
</div>
</div>
<p>To compare partial-pooling and no-pooling estimates, let’s run the unpooled model without the <code class="docutils literal notranslate"><span class="pre">no_stim</span></code> predictor:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">unpooled_bis</span><span class="p">:</span>
    <span class="n">a_mouse</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;a_mouse&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">n_mice</span><span class="p">)</span>
    
    <span class="n">theta</span> <span class="o">=</span> <span class="n">a_mouse</span><span class="p">[</span><span class="n">mouse</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">log_power</span><span class="p">)</span>
    
    <span class="n">unpooled_trace_bis</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
<span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">unpooled_bis</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [sigma, a_mouse]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='12000' class='' max='12000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [12000/12000 00:05<00:00 Sampling 4 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 2_000 tune and 1_000 draw iterations (8_000 + 4_000 draws total) took 5 seconds.
</pre></div>
</div>
<img alt="../_images/multilevel_modeling_lfp_63_3.svg" src="../_images/multilevel_modeling_lfp_63_3.svg" /></div>
</div>
<p>Now let’s compare both models’ estimates for all 85 mice. We’ll plot the estimates against each mouse’s sample size, to let you see more clearly what hierarchical models bring to the table:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">N_mouse</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;mouse&quot;</span><span class="p">)[</span><span class="s2">&quot;idnum&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">axes</span><span class="p">,</span> 
    <span class="p">[</span><span class="n">unpooled_trace_bis</span><span class="p">[</span><span class="s2">&quot;a_mouse&quot;</span><span class="p">],</span> <span class="n">partial_pooling_trace</span><span class="p">[</span><span class="s2">&quot;a_mouse&quot;</span><span class="p">]],</span> 
    <span class="p">[</span><span class="s2">&quot;no pooling&quot;</span><span class="p">,</span> <span class="s2">&quot;partial pooling&quot;</span><span class="p">]</span>
<span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span>
        <span class="n">partial_pooling_trace</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> 
        <span class="mf">0.9</span><span class="p">,</span> 
        <span class="nb">max</span><span class="p">(</span><span class="n">N_mouse</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> 
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> 
        <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> 
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Est. population mean&quot;</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
        <span class="n">N_mouse</span><span class="p">,</span> 
        <span class="n">az</span><span class="o">.</span><span class="n">hpd</span><span class="p">(</span><span class="n">trace</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">],</span> 
        <span class="n">az</span><span class="o">.</span><span class="n">hpd</span><span class="p">(</span><span class="n">trace</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">],</span> <span class="p">[</span><span class="n">l</span><span class="p">,</span> <span class="n">h</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">N_mouse</span><span class="p">,</span> <span class="n">trace</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
        <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">level</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="si">}</span><span class="s2"> Estimates&quot;</span><span class="p">,</span> 
        <span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;Nbr obs in mouse (log scale)&quot;</span><span class="p">,</span> 
        <span class="n">xscale</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">,</span> 
        <span class="n">ylabel</span><span class="o">=</span><span class="s2">&quot;Log power&quot;</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/home/m/anaconda3/envs/tf/lib/python3.6/site-packages/arviz/stats/stats.py:338: UserWarning: hpd will be deprecated Please replace hdi
  warnings.warn((&quot;hpd will be deprecated &quot; &quot;Please replace hdi&quot;),)
/home/m/anaconda3/envs/tf/lib/python3.6/site-packages/arviz/data/base.py:146: UserWarning: More chains (4000) than draws (85). Passed array should have shape (chains, draws, *shape)
  UserWarning,
</pre></div>
</div>
<img alt="../_images/multilevel_modeling_lfp_65_1.png" src="../_images/multilevel_modeling_lfp_65_1.png" />
</div>
</div>
<p>Notice the difference between the unpooled and partially-pooled estimates, particularly at smaller sample sizes: As expected, the former are both more extreme and more imprecise. Indeed, in the partially-pooled model, estimates in small-sample-size mice are informed by the population parameters – hence more precise estimates. Moreover, the smaller the sample size, the more regression towards the overall mean (the dashed gray line) – hence less extreme estimates. In other words, the model is skeptical of extreme deviations from the population mean in mice where data is sparse.</p>
<p>Now let’s try to integrate the <code class="docutils literal notranslate"><span class="pre">no_stim</span></code> predictor! To show you an example with a slope we’re gonna take the indicator variable road, but we could stay with the index variable approach that we used for the no-pooling model. Then we would have one intercept for each category – stim and no_stim.</p>
</div>
<div class="section" id="full-model-partial-pooling-with-treatment">
<h2>Full model: Partial pooling with treatment<a class="headerlink" href="#full-model-partial-pooling-with-treatment" title="Permalink to this headline">¶</a></h2>
<p>As above, this model allows intercepts to vary across mouse, according to a random effect. We just add a fixed slope for the predictor (i.e all mice will have the same slope):</p>
<div class="math notranslate nohighlight">
\[y_i = \alpha_{j[i]} + \beta x_{i} + \epsilon_i\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\epsilon_i \sim N(0, \sigma_y^2)\]</div>
<p>and the intercept random effect:</p>
<div class="math notranslate nohighlight">
\[\alpha_{j[i]} \sim N(\mu_{\alpha}, \sigma_{\alpha}^2)\]</div>
<p>As with the the no-pooling model, we set a separate intercept for each mouse, but rather than fitting separate regression models for each mouse, multilevel modeling <strong>shares strength</strong> among mice, allowing for more reasonable inference in mice with little data. Here is what that looks in code:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">varying_intercept</span><span class="p">:</span>
    <span class="c1"># Hyperpriors:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
    <span class="n">sigma_a</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sigma_a&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    
    <span class="c1"># Varying intercepts:</span>
    <span class="n">a_mouse</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;a_mouse&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">n_mice</span><span class="p">)</span>
    <span class="c1"># Common slope:</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">10.</span><span class="p">)</span>
    
    <span class="c1"># Expected value per mouse:</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">a_mouse</span><span class="p">[</span><span class="n">mouse</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">no_stim</span>
    <span class="c1"># Model error:</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sigma&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    
    <span class="n">y</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">log_power</span><span class="p">)</span>
<span class="n">pm</span><span class="o">.</span><span class="n">model_to_graphviz</span><span class="p">(</span><span class="n">varying_intercept</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_68_0.svg" src="../_images/multilevel_modeling_lfp_68_0.svg" /></div>
</div>
<p>Let’s fit this bad boy with MCMC:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="k">with</span> <span class="n">varying_intercept</span><span class="p">:</span>
    <span class="n">varying_intercept_trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="n">RANDOM_SEED</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Auto-assigning NUTS sampler...
Initializing NUTS using jitter+adapt_diag...
INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
INFO (theano.gof.compilelock): Waiting for existing lock by process &#39;2167213&#39; (I am process &#39;2170020&#39;)
INFO (theano.gof.compilelock): To manually release the lock, delete /home/m/.theano/compiledir_Linux-5.4--generic-x86_64-with-debian-bullseye-sid-x86_64-3.6.10-64/lock_dir
Multiprocess sampling (4 chains in 4 jobs)
NUTS: [sigma, b, a_mouse, sigma_a, a]
</pre></div>
</div>
<div class="output text_html">
<div>
    <style>
        /* Turns off some styling */
        progress {
            /* gets rid of default border in Firefox and Opera. */
            border: none;
            /* Needs to be in here for Safari polyfill so background images work as expected. */
            background-size: auto;
        }
        .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
            background: #F44336;
        }
    </style>
  <progress value='12000' class='' max='12000' style='width:300px; height:20px; vertical-align: middle;'></progress>
  100.00% [12000/12000 00:06<00:00 Sampling 4 chains, 0 divergences]
</div>
</div><div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sampling 4 chains for 2_000 tune and 1_000 draw iterations (8_000 + 4_000 draws total) took 7 seconds.
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_forest</span><span class="p">(</span><span class="n">varying_intercept_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;a_mouse&quot;</span><span class="p">],</span> <span class="n">r_hat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">combined</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_71_0.png" src="../_images/multilevel_modeling_lfp_71_0.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">az</span><span class="o">.</span><span class="n">plot_trace</span><span class="p">(</span><span class="n">varying_intercept_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_72_0.png" src="../_images/multilevel_modeling_lfp_72_0.png" />
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">az</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="n">varying_intercept_trace</span><span class="p">,</span> <span class="n">var_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma_a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;sigma&quot;</span><span class="p">],</span> <span class="n">round_to</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>sd</th>
      <th>hdi_3%</th>
      <th>hdi_97%</th>
      <th>mcse_mean</th>
      <th>mcse_sd</th>
      <th>ess_mean</th>
      <th>ess_sd</th>
      <th>ess_bulk</th>
      <th>ess_tail</th>
      <th>r_hat</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a</th>
      <td>1.49</td>
      <td>0.05</td>
      <td>1.40</td>
      <td>1.59</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>2264.20</td>
      <td>2264.20</td>
      <td>2258.64</td>
      <td>2569.27</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>sigma_a</th>
      <td>0.32</td>
      <td>0.04</td>
      <td>0.24</td>
      <td>0.41</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1248.56</td>
      <td>1248.56</td>
      <td>1213.04</td>
      <td>1615.95</td>
      <td>1.01</td>
    </tr>
    <tr>
      <th>b</th>
      <td>-0.66</td>
      <td>0.07</td>
      <td>-0.80</td>
      <td>-0.54</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>3335.23</td>
      <td>3335.23</td>
      <td>3303.54</td>
      <td>2909.08</td>
      <td>1.00</td>
    </tr>
    <tr>
      <th>sigma</th>
      <td>0.73</td>
      <td>0.02</td>
      <td>0.69</td>
      <td>0.76</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>4975.12</td>
      <td>4953.96</td>
      <td>5015.64</td>
      <td>2859.70</td>
      <td>1.00</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As we suspected, the estimate for the <code class="docutils literal notranslate"><span class="pre">no_stim</span></code> coefficient is reliably negative and centered around -0.66. This can be interpreted as neurons without stims having about half (<span class="math notranslate nohighlight">\(\exp(-0.66) = 0.52\)</span>) the power levels of those with stims, after accounting for mouse. Note that this is only the <em>relative</em> effect of no_stim on power levels: conditional on being in a given mouse, power is expected to be half lower in neurons without stims than in neurons with. To see how much difference a stim makes on the <em>absolute</em> level of power, we’d have to push the parameters through the model, as we do with posterior predictive checks and as we’ll do just now.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">xvals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">avg_a_mouse</span> <span class="o">=</span> <span class="n">varying_intercept_trace</span><span class="p">[</span><span class="s2">&quot;a_mouse&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">avg_b</span> <span class="o">=</span> <span class="n">varying_intercept_trace</span><span class="p">[</span><span class="s2">&quot;b&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="k">for</span> <span class="n">a_c</span> <span class="ow">in</span> <span class="n">avg_a_mouse</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xvals</span><span class="p">,</span> <span class="n">a_c</span> <span class="o">+</span> <span class="n">avg_b</span> <span class="o">*</span> <span class="n">xvals</span><span class="p">,</span> <span class="s1">&#39;ko-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;stim&quot;</span><span class="p">,</span> <span class="s2">&quot;no_stim&quot;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Mean log power&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Mean power by mouse&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_75_0.png" src="../_images/multilevel_modeling_lfp_75_0.png" />
</div>
</div>
<p>The graph above shows, for each mouse, the expected log power level and the average effect of having no stim – these are the absolute effects we were talking about. Two caveats though:</p>
<ol class="simple">
<li><p>This graph doesn’t show the uncertainty for each mouse – how confident are we that the average estimates are where the graph shows? For that we’d need to combine the uncertainty in <code class="docutils literal notranslate"><span class="pre">a_mouse</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code>, and this would of course vary by mouse. I didn’t show it here because the graph would get cluttered, but go ahead and do it for a subset of mice.</p></li>
<li><p>These are only <em>average</em> estimates at the <em>mouse-level</em> (<code class="docutils literal notranslate"><span class="pre">theta</span></code> in the model): they don’t take into account the variation by neuron. To add this other layer of uncertainty we’d need to take stock of the effect of <code class="docutils literal notranslate"><span class="pre">sigma</span></code> and generate samples from the <code class="docutils literal notranslate"><span class="pre">y</span></code> variable to see the effect on given neurons (that’s exactly the role of posterior predictive checks).</p></li>
</ol>
<p>That being said, it is easy to show that the partial pooling model provides more objectively reasonable estimates than either the pooled or unpooled models, at least for mice with small sample sizes:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># HIDE CODE</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SAMPLE_mice</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">no_stim</span><span class="p">[</span><span class="n">srrs_mn</span><span class="o">.</span><span class="n">mouse</span><span class="o">==</span><span class="n">c</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">srrs_mn</span><span class="o">.</span><span class="n">log_power</span><span class="p">[</span><span class="n">srrs_mn</span><span class="o">.</span><span class="n">mouse</span><span class="o">==</span><span class="n">c</span><span class="p">]</span>
    
    <span class="c1"># plot obs:</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">*</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
    <span class="c1"># complete-pooling model:</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="n">a_stim</span><span class="p">,</span> <span class="n">a_no_stim</span><span class="p">],</span> <span class="s2">&quot;r--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Complete pooling&quot;</span><span class="p">)</span>
    <span class="c1"># no-pooling model:</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
        <span class="p">[</span><span class="n">unpooled_stim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;stim&quot;</span><span class="p">]</span> <span class="p">,</span> <span class="n">unpooled_no_stim</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">c</span><span class="p">,</span> <span class="s2">&quot;no_stim&quot;</span><span class="p">]],</span>
        <span class="s2">&quot;k:&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;No pooling&quot;</span>
    <span class="p">)</span>
    <span class="c1"># partial-pooling model:</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
        <span class="p">[</span><span class="n">avg_a_mouse</span><span class="p">[</span><span class="n">mouse_lookup</span><span class="p">[</span><span class="n">c</span><span class="p">]],</span> <span class="n">avg_a_mouse</span><span class="p">[</span><span class="n">mouse_lookup</span><span class="p">[</span><span class="n">c</span><span class="p">]]</span> <span class="o">+</span> <span class="n">avg_b</span><span class="p">],</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Partial pooling&quot;</span>
    <span class="p">)</span>
    
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">&quot;stim&quot;</span><span class="p">,</span> <span class="s2">&quot;no_stim&quot;</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">%</span><span class="k">2</span>:
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Log power level&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">%</span><span class="k">4</span>:
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/multilevel_modeling_lfp_77_0.png" src="../_images/multilevel_modeling_lfp_77_0.png" />
</div>
</div>
<p>Here we clearly see the notion that partial-pooling is a compromise between no pooling and complete pooling, as its mean estimates are usually between the other models’ estimates. And interestingly, the bigger (smaller) the sample size in a given mouse, the closer the partial-pooling estimates are to the no-pooling (complete-pooling) estimates.</p>
<p>We see however that mice vary by more than just their baseline rates: the effect of no_stim seems to be different from one mouse to another. It would be great if our model could take that into account, wouldn’t it? Well to do that, we need to allow the slope to vary by mouse – not only the intercept – and here is how you can do it with PyMC3.</p>
</div>
<div class="section" id="benefits-of-multilevel-models">
<h2>Benefits of Multilevel Models<a class="headerlink" href="#benefits-of-multilevel-models" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Accounting for natural hierarchical structure of observational data.</p></li>
<li><p>Estimation of coefficients for (under-represented) groups.</p></li>
<li><p>Incorporating individual- and group-level information when estimating group-level coefficients.</p></li>
<li><p>Allowing for variation among individual-level coefficients across groups.</p></li>
</ul>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Gelman, A., &amp; Hill, J. (2006), <em>Data Analysis Using Regression and Multilevel/Hierarchical Models (1st ed.)</em>, Cambridge University Press.</p></li>
<li><p>Gelman, A. (2006), <em>Multilevel (Hierarchical) modeling: what it can and cannot do</em>, Technometrics, 48(3), 432–435.</p></li>
<li><p>McElreath, R. (2020), <em>Statistical Rethinking - A Bayesian Course with Examples in R and Stan (2nd ed.)</em>, CRC Press.</p></li>
</ul>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./motivation"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By The Jupyter Book Community<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>